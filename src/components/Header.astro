---
import { getSite } from "../utils/consts";
import SearchModal from "./SearchModal.astro";
import ThemeToggle from "./ThemeToggle.astro";

const site = await getSite();
import { Icon } from "astro-icon/components";
const subpath = import.meta.env.BASE_URL;

const brandColors = [
  "var(--color-brand-orange)",
  "var(--color-brand-pink)",
  "var(--color-brand-green)",
  "var(--color-brand-blue)",
];
const darkTextColors = new Set(["var(--color-brand-blue)"]);
const navLinks = site.nav ?? [];

---

<header class="flex gap-1 flex-row h-16 md:h-20 overflow-hidden">
  <a
    href={subpath}
    aria-label={site.title}
    class="rounded-xl overflow-hidden px-5 md:px-8 flex h-full items-center bg-[var(--color-brand-yellow)] font-bold leading-none shrink-0 md:justify-start md:text-lg md:leading-none no-underline text-[var(--color-off-black)] gap-3"
  >
    <Icon
      name="tabler:math-symbols"
      size="1.5em"
      class="inline-block align-middle shrink-0"
      aria-hidden="true"
    />
    <span class="whitespace-nowrap">{site.title}</span>
  </a>
  <div class="rounded-xl overflow-hidden grow bg-[var(--color-brand-yellow)] min-w-2 shrink"></div>
  <nav
    class="hidden md:flex items-center gap-1 shrink-0"
  >
    {navLinks.map((link, i) => {
      const bg = brandColors[i % brandColors.length];
      const textColor = darkTextColors.has(bg) ? "var(--color-off-white)" : "var(--color-off-black)";
      return (
        <a href={link.href} class="rounded-xl px-5 py-2 h-full flex items-center text-sm font-semibold tracking-wide uppercase hover:bg-[var(--color-off-black)] hover:text-[var(--color-off-white)] transition-colors no-underline whitespace-nowrap" style={`background:${bg};color:${textColor}`}>{link.label}</a>
      );
    })}
  </nav>
  <div class="flex items-center gap-1 shrink-0 h-full">
    <button
      class="inline-flex items-center gap-2 group rounded-xl text-[var(--color-off-black)] hover:bg-[var(--color-off-black)] hover:text-[var(--color-off-white)] antialiased transition-colors text-lg w-1/3 justify-center bg-[var(--color-brand-yellow)] px-6 h-full sm:w-auto md:hidden cursor-pointer"
      type="button"
      id="nav-toggle"
      aria-label="Toggle navigation"
      aria-pressed="false"
    >
      <span class="inline-flex [html[data-nav='open']_&]:hidden" aria-hidden="true">
        <Icon name="tabler:menu-2" size={20} stroke-width={1.6} />
      </span>
      <span class="hidden [html[data-nav='open']_&]:inline-flex" aria-hidden="true">
        <Icon name="tabler:x" size={20} stroke-width={1.6} />
      </span>
      Menu
    </button>
    <SearchModal />
    <ThemeToggle />
  </div>
</header>

<!-- Mobile nav -->
<div class="md:hidden [html[data-nav='closed']_&]:hidden flex flex-col gap-1">
  {navLinks.map((link, i) => {
    const bg = brandColors[i % brandColors.length];
    const textColor = darkTextColors.has(bg) ? "var(--color-off-white)" : "var(--color-off-black)";
    return (
      <a href={link.href} class="rounded-xl px-5 py-4 flex items-center text-sm font-semibold tracking-wide uppercase hover:bg-[var(--color-off-black)] hover:text-[var(--color-off-white)] transition-colors no-underline" style={`background:${bg};color:${textColor}`}>{link.label}</a>
    );
  })}
</div>

<script is:inline>
  const applyNav = (state) => {
    const isOpen = state === "open";
    document.documentElement.dataset.nav = isOpen ? "open" : "closed";
    const button = document.getElementById("nav-toggle");
    if (button) button.setAttribute("aria-pressed", isOpen ? "true" : "false");
  };

  const toggleNav = () => {
    const current =
      document.documentElement.dataset.nav === "open" ? "open" : "closed";
    const next = current === "open" ? "closed" : "open";
    applyNav(next);
  };

  applyNav("closed");

  const navButton = document.getElementById("nav-toggle");
  if (navButton) {
    navButton.addEventListener("click", toggleNav);
  }

  document.addEventListener("click", (event) => {
    if (document.documentElement.dataset.nav !== "open") return;
    const target = event.target;
    if (!(target instanceof Element)) return;
    const clickedToggle = navButton && navButton.contains(target);
    const header = document.querySelector("header");
    const clickedHeader = header && header.contains(target);
    if (!clickedToggle && !clickedHeader) {
      applyNav("closed");
    }
  });
</script>
